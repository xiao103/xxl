<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•è¯æ¶ˆæ¶ˆä¹</title>
    <!-- å¼•å…¥SheetJSåº“ç”¨äºExcelè§£æ -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- å¼•å…¥confettiåº“ç”¨äºæ¸¸æˆèƒœåˆ©æ•ˆæœ -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- å¼•å…¥howler.jsç”¨äºéŸ³æ•ˆ -->
    <script src="https://cdn.jsdelivr.net/npm/howler@2.2.3/dist/howler.min.js"></script>
    <style>
        /* è«å…°è¿ªè‰²ç³» */
        :root {
            --mauve: #D8B4A0;
            --dusty-pink: #DDBEA9;
            --sage: #A5A58D;
            --olive: #B7B7A4;
            --taupe: #6B705C;
            --pale-pink: #FFE8D6;
            --soft-white: #F8F4E9;
            --light-gray: #E2DED3;
            --dark-taupe: #4A4A3C;
            
            /* æ¢å¤å¡ç‰‡ç³–æœè‰² */
            --candy-red: #FF6B6B;
            --candy-orange: #FFA36B;
            --candy-yellow: #FFD56B;
            --candy-green: #A3E06B;
            --candy-mint: #6BE0A3;
            --candy-blue: #6BA3E0;
            --candy-purple: #A36BE0;
            --candy-pink: #E06BA3;
        }

        body {
            font-family: 'Comic Sans MS', 'Marker Felt', 'åæ–‡ç¥ç€', cursive, sans-serif;
            background-color: var(--soft-white);
            margin: 0;
            padding: 20px;
            color: var(--dark-taupe);
            min-height: 100vh;
            background-image:
                radial-gradient(circle at 10% 20%, rgba(216, 180, 160, 0.2) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(165, 165, 141, 0.2) 0%, transparent 20%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--soft-white);
            border-radius: 30px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(107, 112, 92, 0.1);
            border: 6px solid var(--sage);
            position: relative;
            overflow: hidden;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 25px;
        }

        .container::before {
            content: "";
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border: 4px dashed var(--olive);
            border-radius: 35px;
            pointer-events: none;
            animation: rotate 60s linear infinite;
        }

        @keyframes rotate {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        h1 {
            text-align: center;
            font-size: 3.5em;
            margin-bottom: 25px;
            text-shadow: 3px 3px 0 rgba(221, 190, 169, 0.3);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            display: inline-block;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, var(--taupe), var(--sage), var(--olive));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            padding: 0 25px;
            grid-column: 1 / -1;
            letter-spacing: 2px;
        }

        h1:hover {
            transform: translateX(-50%) scale(1.05);
            text-shadow: 5px 5px 0 rgba(221, 190, 169, 0.3);
        }

        h1::after {
            content: "";
            position: absolute;
            bottom: 5px;
            left: 20%;
            width: 60%;
            height: 8px;
            background: linear-gradient(90deg, var(--mauve), var(--dusty-pink), var(--sage), var(--olive), var(--taupe));
            border-radius: 5px;
            z-index: -1;
            opacity: 0.5;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 25px;
            padding: 25px;
            background-color: var(--pale-pink);
            border-radius: 20px;
            border: 4px solid var(--olive);
            position: relative;
            overflow: hidden;
        }

        .left-panel::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23A5A58D' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.3;
            z-index: 0;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
            z-index: 1;
            text-align: center;
        }

        .control-group label {
            font-size: 1.4em;
            margin-bottom: 10px;
        }

        label {
            font-weight: bold;
            color: var(--taupe);
            font-size: 1.2em;
            text-shadow: 1px 1px 0 var(--soft-white);
        }

        input[type="range"] {
            width: 100%;
            height: 25px;
            -webkit-appearance: none;
            background: linear-gradient(to right, var(--mauve), var(--dusty-pink), var(--sage), var(--olive), var(--taupe));
            border-radius: 15px;
            outline: none;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.1);
            border: 3px solid var(--soft-white);
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 30px;
            height: 30px;
            background: var(--soft-white);
            border-radius: 50%;
            border: 4px solid var(--taupe);
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }

        .word-count {
            font-weight: bold;
            color: var(--taupe);
            font-size: 1.5em;
            background-color: var(--soft-white);
            padding: 5px 15px;
            border-radius: 15px;
            border: 2px solid var(--taupe);
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.1);
            margin: 10px auto;
            display: inline-block;
        }

        button {
            background: linear-gradient(145deg, var(--sage), var(--olive));
            color: var(--soft-white);
            border: none;
            padding: 15px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em;
            transition: all 0.3s;
            box-shadow: 0 5px 0 var(--taupe), 0 10px 15px rgba(107, 112, 92, 0.2);
            position: relative;
            overflow: hidden;
            z-index: 1;
            text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.2);
            width: 100%;
            margin: 5px 0;
        }

        button::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(145deg, var(--olive), var(--sage));
            opacity: 0;
            z-index: -1;
            transition: opacity 0.3s;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 0 var(--taupe), 0 15px 20px rgba(107, 112, 92, 0.3);
        }

        button:hover::before {
            opacity: 1;
        }

        button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 var(--taupe), 0 5px 10px rgba(107, 112, 92, 0.2);
        }

        .timer {
            text-align: center;
            font-size: 1.8em;
            color: var(--taupe);
            font-weight: bold;
            background-color: var(--soft-white);
            padding: 15px;
            border-radius: 50px;
            border: 3px solid var(--olive);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin: 10px 0;
        }

        .timer::before {
            content: "â±";
            margin-right: 10px;
            color: var(--sage);
        }

        .word-panel {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px;
            align-content: start;
            padding: 20px;
        }

        /* å¡ç‰‡æ¢å¤ä¸ºç³–æœè‰² */
        .word-card {
            background: var(--candy-blue);
            border-radius: 20px;
            height: 90px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            border: 4px solid white;
            color: white;
            text-align: center;
            padding: 10px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        /* ä¸ºä¸åŒå¡ç‰‡è®¾ç½®ä¸åŒçš„ç³–æœè‰² */
        .word-card:nth-child(8n + 1) {
            background: var(--candy-red);
        }

        .word-card:nth-child(8n + 2) {
            background: var(--candy-orange);
        }

        .word-card:nth-child(8n + 3) {
            background: var(--candy-yellow);
            color: #5A3D5C;
            text-shadow: none;
        }

        .word-card:nth-child(8n + 4) {
            background: var(--candy-green);
        }

        .word-card:nth-child(8n + 5) {
            background: var(--candy-mint);
        }

        .word-card:nth-child(8n + 6) {
            background: var(--candy-blue);
        }

        .word-card:nth-child(8n + 7) {
            background: var(--candy-purple);
        }

        .word-card:nth-child(8n + 8) {
            background: var(--candy-pink);
        }

        .word-card:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            z-index: 2;
        }

        .word-card::before {
            content: "";
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border: 3px dashed white;
            border-radius: 25px;
            opacity: 0;
            transition: all 0.3s;
        }

        .word-card:hover::before {
            opacity: 0.6;
            animation: rotate 10s linear infinite;
        }

        .word-card.flipped {
            background: linear-gradient(145deg, #FFD6E7, #FFC0CB) !important;
            color: transparent !important;
            transform: rotateY(180deg);
        }

        .word-card.matched {
            animation: matchAnimation 0.5s forwards;
            pointer-events: none;
        }

        @keyframes matchAnimation {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.2);
                opacity: 0.8;
                background: white;
            }

            100% {
                transform: scale(0);
                opacity: 0;
            }
        }

        .word-card::after {
            content: '?';
            position: absolute;
            color: white;
            font-size: 2.5em;
            opacity: 0;
            transition: all 0.3s;
            text-shadow: 2px 2px 0 rgba(0, 0, 0, 0.2);
        }

        .word-card.flipped::after {
            opacity: 1;
        }

        .file-input {
            display: none;
        }

        .builtin-wordbanks {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 15px 0;
        }

        .builtin-wordbank {
            background: linear-gradient(145deg, var(--olive), var(--sage));
            padding: 12px 16px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s;
            box-shadow: 0 4px 0 var(--taupe), 0 5px 10px rgba(107, 112, 92, 0.2);
            border: 2px solid var(--soft-white);
            color: var(--soft-white);
            font-weight: bold;
            position: relative;
            overflow: hidden;
            text-align: center;
        }

        .builtin-wordbank::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(145deg, var(--sage), var(--olive));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .builtin-wordbank:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 0 var(--taupe), 0 10px 15px rgba(107, 112, 92, 0.3);
        }

        .builtin-wordbank:hover::before {
            opacity: 1;
        }

        .builtin-wordbank:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 var(--taupe), 0 3px 5px rgba(107, 112, 92, 0.2);
        }

        .volume-control {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--soft-white);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            z-index: 100;
            border: 3px solid var(--taupe);
        }

        .volume-control i {
            font-size: 24px;
            color: var(--taupe);
        }

        /* å°å±å¹•è®¾å¤‡ï¼ˆå¦‚æ‰‹æœºï¼‰ */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                max-width: 100%;
                padding: 15px;
            }

            .word-panel {
                grid-template-columns: repeat(2, 1fr);
            }

            h1 {
                font-size: 2.5em;
            }

            .timer {
                font-size: 1.5em;
            }

            .builtin-wordbank {
                width: 100%;
            }
        }

        /* ä¸­ç­‰å±å¹•è®¾å¤‡ï¼ˆå¦‚å¹³æ¿ï¼‰ */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                grid-template-columns: 250px 1fr;
                padding: 20px;
            }

            .word-panel {
                grid-template-columns: repeat(3, 1fr);
            }

            h1 {
                font-size: 3em;
            }
        }
    </style>
    <!-- ä½¿ç”¨Font Awesomeå›¾æ ‡ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="container">
        <h1 id="game-title">å•è¯æ¶ˆæ¶ˆä¹</h1>

        <div class="left-panel">
            <div class="control-group">
                <label for="word-count">å•è¯å¯¹æ•°</label>
                <input type="range" id="word-count" min="5" max="50" value="10">
                <span class="word-count" id="word-count-display">10</span>
            </div>

            <button id="start-btn"><i class="fas fa-play"></i> å¼€å§‹æ¸¸æˆ</button>
            
            <div class="timer" id="timer">è€—æ—¶: 0ç§’</div>

            <button id="import-btn"><i class="fas fa-file-import"></i> å¯¼å…¥è¯è¡¨</button>
            <input type="file" id="file-input" class="file-input" accept=".xlsx,.xls,.csv">

            <div class="builtin-wordbanks" id="builtin-wordbanks">
                <div class="builtin-wordbank" data-wordbank="grade3"><i class="fas fa-grde3"></i> ä¸‰å¹´çº§å•è¯</div>
                <div class="builtin-wordbank" data-wordbank="fruits"><i class="fas fa-apple-alt"></i> æ°´æœå•è¯</div>
                <div class="builtin-wordbank" data-wordbank="animals"><i class="fas fa-paw"></i> åŠ¨ç‰©å•è¯</div>
                <div class="builtin-wordbank" data-wordbank="school"><i class="fas fa-school"></i> å­¦æ ¡ç”¨å“</div>
                <div class="builtin-wordbank" data-wordbank="colors"><i class="fas fa-palette"></i> é¢œè‰²å•è¯</div>
                <div class="builtin-wordbank" data-wordbank="family"><i class="fas fa-home"></i> å®¶åº­æˆå‘˜</div>
            </div>
        </div>

        <div class="word-panel" id="word-panel"></div>
    </div>

    <div class="volume-control" id="volume-control">
        <i class="fas fa-volume-up"></i>
    </div>

    <script>
        // å†…ç½®å•è¯åº“
        const builtinWordBanks = {
            grade3:[
                ["UK","è‹±å›½"],
["Canada","åŠ æ‹¿å¤§"],
["USA","ç¾å›½"],
["China","ä¸­å›½"],
["she","å¥¹"],
["student","å­¦ç”Ÿ"],
["pupil","å°å­¦ç”Ÿ"],
["he","ä»–"],
["teacher","è€å¸ˆ"],
["boy","ç”·å­©"],
["girl","å¥³å­©"],
["new","æ–°çš„"],
["friend","æœ‹å‹"],
["today","ä»Šå¤©"],
["father","çˆ¶äº²ï¼›çˆ¸çˆ¸"],
["dad","ï¼ˆå£è¯­ï¼‰çˆ¸çˆ¸ï¼›çˆ¹çˆ¹"],
["man","ç”·äºº"],
["woman","å¥³äºº"],
["mother","æ¯äº²ï¼›å¦ˆå¦ˆ"],
["sister","å§ï¼›å¦¹"],
["brother","å…„ï¼›å¼Ÿ"],
["grandmother","ï¼ˆå¤–ï¼‰ç¥–æ¯"],
["grandma","ï¼ˆå£è¯­ï¼‰(å¤–)ç¥–æ¯"],
["grandfather","(å¤–)ç¥–çˆ¶"],
["grandpa","ï¼ˆå£è¯­ï¼‰ï¼ˆå¤–ï¼‰ç¥–çˆ¶"],
["family","å®¶ï¼›å®¶åº­"],
["thin","ç˜¦çš„"],
["fat","èƒ–çš„"],
["tall","é«˜çš„"],
["short","çŸ®çš„ï¼›çŸ­çš„"],
["long","é•¿çš„"],
["small","å°çš„"],
["big","å¤§çš„"],
["giraffe","é•¿é¢ˆé¹¿"],
["so","è¿™ä¹ˆï¼›é‚£ä¹ˆ"],
["children","å­©å­çš„å¤æ•°"],
["child","å­©å­"],
["tail","å°¾å·´"],
["on","åœ¨â€¦â€¦ä¸Š"],
["in","åœ¨â€¦â€¦é‡Œ"],
["under","åœ¨â€¦â€¦ä¸‹é¢"],
["chair","æ¤…å­"],
["desk","æ¡Œå­"],
["cap","å¸½å­"],
["ball","çƒ"],
["car","å°æ±½è½¦"],
["boat","èˆ¹"],
["map","åœ°å›¾"],
["toy","ç©å…·"],
["box","ç›’ï¼›ç®±"],
["pear","æ¢¨"],
["apple","è‹¹æœ"],
["orange","æ©™å­"],
["banana","é¦™è•‰"],
["watermelon","è¥¿ç“œ"],
["strawberry","è‰è“"],
["grape","è‘¡è„"],
["buy","ä¹°"],
["fruit","æ°´æœ"],
["eleven","åä¸€"],
["twelve","åäºŒ"],
["thirteen","åä¸‰"],
["fourteen","åå››"],
["fifteen","åäº”"],
["sixteen","åå…­"],
["seventeen","åä¸ƒ"],
["eighteen","åå…«"],
["nineteen","åä¹"],
["twenty","äºŒå"],
["kite","é£ç­"],
["beautiful","ç¾ä¸½çš„"]
            ],
            fruits: [
                ['apple', 'è‹¹æœ'],
                ['banana', 'é¦™è•‰'],
                ['orange', 'æ©™å­'],
                ['grape', 'è‘¡è„'],
                ['watermelon', 'è¥¿ç“œ'],
                ['strawberry', 'è‰è“'],
                ['pineapple', 'è è'],
                ['pear', 'æ¢¨'],
                ['peach', 'æ¡ƒå­'],
                ['cherry', 'æ¨±æ¡ƒ'],
                ['mango', 'èŠ’æœ'],
                ['lemon', 'æŸ æª¬'],
                ['coconut', 'æ¤°å­'],
                ['kiwi', 'çŒ•çŒ´æ¡ƒ'],
                ['blueberry', 'è“è“']
            ],
            animals: [
                ['dog', 'ç‹—'],
                ['cat', 'çŒ«'],
                ['elephant', 'å¤§è±¡'],
                ['lion', 'ç‹®å­'],
                ['tiger', 'è€è™'],
                ['monkey', 'çŒ´å­'],
                ['panda', 'ç†ŠçŒ«'],
                ['rabbit', 'å…”å­'],
                ['bear', 'ç†Š'],
                ['giraffe', 'é•¿é¢ˆé¹¿'],
                ['zebra', 'æ–‘é©¬'],
                ['kangaroo', 'è¢‹é¼ '],
                ['penguin', 'ä¼é¹…'],
                ['dolphin', 'æµ·è±š'],
                ['whale', 'é²¸é±¼']
            ],
            school: [
                ['pen', 'é’¢ç¬”'],
                ['pencil', 'é“…ç¬”'],
                ['book', 'ä¹¦'],
                ['notebook', 'ç¬”è®°æœ¬'],
                ['eraser', 'æ©¡çš®'],
                ['ruler', 'å°ºå­'],
                ['bag', 'ä¹¦åŒ…'],
                ['desk', 'è¯¾æ¡Œ'],
                ['chair', 'æ¤…å­'],
                ['blackboard', 'é»‘æ¿'],
                ['teacher', 'è€å¸ˆ'],
                ['student', 'å­¦ç”Ÿ'],
                ['classroom', 'æ•™å®¤'],
                ['homework', 'å®¶åº­ä½œä¸š'],
                ['test', 'è€ƒè¯•']
            ],
            colors: [
                ['red', 'çº¢è‰²'],
                ['blue', 'è“è‰²'],
                ['green', 'ç»¿è‰²'],
                ['yellow', 'é»„è‰²'],
                ['orange', 'æ©™è‰²'],
                ['purple', 'ç´«è‰²'],
                ['pink', 'ç²‰è‰²'],
                ['black', 'é»‘è‰²'],
                ['white', 'ç™½è‰²'],
                ['brown', 'æ£•è‰²'],
                ['gray', 'ç°è‰²'],
                ['gold', 'é‡‘è‰²'],
                ['silver', 'é“¶è‰²'],
                ['rainbow', 'å½©è™¹'],
                ['colorful', 'äº”å½©ç¼¤çº·çš„']
            ],
            family: [
                ['father', 'çˆ¸çˆ¸'],
                ['mother', 'å¦ˆå¦ˆ'],
                ['brother', 'å…„å¼Ÿ'],
                ['sister', 'å§å¦¹'],
                ['grandfather', 'çˆ·çˆ·'],
                ['grandmother', 'å¥¶å¥¶'],
                ['uncle', 'å”å”'],
                ['aunt', 'é˜¿å§¨'],
                ['cousin', 'å ‚å…„å¼Ÿå§å¦¹'],
                ['son', 'å„¿å­'],
                ['daughter', 'å¥³å„¿'],
                ['parents', 'çˆ¶æ¯'],
                ['grandparents', 'ç¥–çˆ¶æ¯'],
                ['family', 'å®¶åº­'],
                ['baby', 'å©´å„¿']
            ]
        };

        // éŸ³æ•ˆ - ä½¿ç”¨æœ¬åœ°æ–‡ä»¶
        const sounds = {
            flip: new Howl({ src: ['flip.mp3'] }),
            match: new Howl({ src: ['match.mp3'] }),
            mismatch: new Howl({ src: ['mismatch.mp3'] }),
            gameStart: new Howl({ src: ['game-start.mp3'] }),
            gameWin: new Howl({ src: ['game-over.mp3'] }),
            background: new Howl({
                src: ['background.mp3'],
                loop: true,
                volume: 0.3
            })
        };

        // æ¸¸æˆçŠ¶æ€
        const gameState = {
            wordPairs: [],
            displayedWords: [],
            flippedCards: [],
            matchedPairs: 0,
            totalPairs: 10,
            startTime: null,
            timerInterval: null,
            isGameStarted: false,
            isGameReady: false,
            soundEnabled: true
        };

        // DOMå…ƒç´ 
        const elements = {
            title: document.getElementById('game-title'),
            wordCountInput: document.getElementById('word-count'),
            wordCountDisplay: document.getElementById('word-count-display'),
            importBtn: document.getElementById('import-btn'),
            fileInput: document.getElementById('file-input'),
            startBtn: document.getElementById('start-btn'),
            timer: document.getElementById('timer'),
            wordPanel: document.getElementById('word-panel'),
            builtinWordBanks: document.getElementById('builtin-wordbanks'),
            volumeControl: document.getElementById('volume-control')
        };

        // åˆå§‹åŒ–
        function init() {
            // æ’­æ”¾èƒŒæ™¯éŸ³ä¹
            if (gameState.soundEnabled) {
                sounds.background.play();
            }

            // æ ‡é¢˜ç‚¹å‡»äº‹ä»¶
            elements.title.addEventListener('click', () => {
                const newTitle = prompt('è¯·è¾“å…¥æ–°çš„æ¸¸æˆæ ‡é¢˜:', elements.title.textContent);
                if (newTitle) {
                    elements.title.textContent = newTitle;
                }
            });

            // å•è¯æ•°é‡æ»‘å—äº‹ä»¶
            elements.wordCountInput.addEventListener('input', () => {
                const count = elements.wordCountInput.value;
                elements.wordCountDisplay.textContent = count;
                gameState.totalPairs = parseInt(count);

                if (gameState.wordPairs.length > 0) {
                    prepareGame();
                }
            });

            // å¯¼å…¥è¯è¡¨æŒ‰é’®äº‹ä»¶
            elements.importBtn.addEventListener('click', () => {
                elements.fileInput.click();
            });

            // å¼€å§‹æ¸¸æˆæŒ‰é’®äº‹ä»¶
            elements.startBtn.addEventListener('click', startGame);

            // æ–‡ä»¶è¾“å…¥äº‹ä»¶
            elements.fileInput.addEventListener('change', handleFileUpload);

            // å†…ç½®è¯åº“ç‚¹å‡»äº‹ä»¶
            elements.builtinWordBanks.addEventListener('click', (e) => {
                if (e.target.classList.contains('builtin-wordbank')) {
                    const wordbank = e.target.dataset.wordbank;
                    loadBuiltinWordBank(wordbank);
                }
            });

            // éŸ³é‡æ§åˆ¶
            elements.volumeControl.addEventListener('click', toggleSound);

            // é»˜è®¤åŠ è½½æ°´æœå•è¯åº“
            loadBuiltinWordBank('fruits');
        }

        // åˆ‡æ¢éŸ³æ•ˆ
        function toggleSound() {
            gameState.soundEnabled = !gameState.soundEnabled;

            if (gameState.soundEnabled) {
                Howler.mute(false);
                elements.volumeControl.innerHTML = '<i class="fas fa-volume-up"></i>';
                sounds.background.play();
            } else {
                Howler.mute(true);
                elements.volumeControl.innerHTML = '<i class="fas fa-volume-mute"></i>';
            }
        }

        // åŠ è½½å†…ç½®å•è¯åº“
        function loadBuiltinWordBank(wordbank) {
            if (builtinWordBanks[wordbank]) {
                gameState.wordPairs = builtinWordBanks[wordbank];
                prepareGame();

                if (gameState.soundEnabled) {
                    sounds.flip.play();
                }
            }
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    // è¿‡æ»¤ç©ºè¡Œå’Œæ— æ•ˆæ•°æ®
                    const wordPairs = jsonData
                       .filter(row => row.length >= 2 && row[0] && row[1])
                       .map(row => [String(row[0]), String(row[1])]);

                    if (wordPairs.length > 0) {
                        gameState.wordPairs = wordPairs;
                        prepareGame();

                        if (gameState.soundEnabled) {
                            sounds.flip.play();
                        }
                    } else {
                        alert('å¯¼å…¥å¤±è´¥ï¼šExcelæ–‡ä»¶ä¸­æ²¡æœ‰æœ‰æ•ˆçš„å•è¯å¯¹');
                    }
                } catch (error) {
                    alert('è§£æExcelæ–‡ä»¶æ—¶å‡ºé”™: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // å‡†å¤‡æ¸¸æˆ
    function prepareGame() {
        clearInterval(gameState.timerInterval);
        gameState.isGameStarted = false;
        gameState.isGameReady = false;
        gameState.matchedPairs = 0;
        gameState.flippedCards = [];
        elements.timer.textContent = 'è€—æ—¶: 0ç§’';

        // ç¡®ä¿å•è¯å¯¹æ•°ä¸è¶…è¿‡å¯ç”¨å•è¯å¯¹æ•°
        const availablePairs = gameState.wordPairs.length;
        const requestedPairs = Math.min(gameState.totalPairs, availablePairs);
        
        // æ›´æ–°æ»‘å—æœ€å¤§å€¼å’Œå½“å‰å€¼
        elements.wordCountInput.max = availablePairs;
        if (gameState.totalPairs > availablePairs) {
            gameState.totalPairs = availablePairs;
            elements.wordCountInput.value = availablePairs;
            elements.wordCountDisplay.textContent = availablePairs;
        }

        // é€‰æ‹©è¦æ˜¾ç¤ºçš„å•è¯å¯¹
        const selectedPairs = selectRandomPairs(gameState.wordPairs, gameState.totalPairs);
        gameState.displayedWords = createWordCards(selectedPairs);

        // æ¸²æŸ“å•è¯é¢æ¿
        renderWordPanel();

        gameState.isGameReady = true;
        elements.startBtn.innerHTML = '<i class="fas fa-play"></i> å¼€å§‹æ¸¸æˆ';
    }

    // ä»è¯è¡¨ä¸­éšæœºé€‰æ‹©æŒ‡å®šæ•°é‡çš„å•è¯å¯¹
    function selectRandomPairs(pairs, count) {
        if (!pairs || pairs.length === 0) return [];
        
        // ç¡®ä¿è¯·æ±‚çš„æ•°é‡ä¸è¶…è¿‡å¯ç”¨æ•°é‡
        const maxPairs = Math.min(count, pairs.length);
        
        // å¤åˆ¶æ•°ç»„ä»¥é¿å…ä¿®æ”¹åŸæ•°ç»„
        const shuffled = [...pairs].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, maxPairs);
    }

        // åˆ›å»ºå•è¯å¡ç‰‡æ•°ç»„
        function createWordCards(pairs) {
            const cards = [];

            pairs.forEach(pair => {
                // æ¯å¯¹å•è¯åˆ›å»ºä¸¤å¼ å¡ç‰‡
                cards.push({
                    text: pair[0],
                    pairId: pair.join('|'),
                    isFlipped: false,
                    isMatched: false
                });

                cards.push({
                    text: pair[1],
                    pairId: pair.join('|'),
                    isFlipped: false,
                    isMatched: false
                });
            });

            // æ‰“ä¹±å¡ç‰‡é¡ºåº
            return cards.sort(() => 0.5 - Math.random());
        }

        // æ¸²æŸ“å•è¯é¢æ¿
        function renderWordPanel() {
            elements.wordPanel.innerHTML = '';

            gameState.displayedWords.forEach((word, index) => {
                if (word.isMatched) return; // å·²åŒ¹é…çš„å¡ç‰‡ä¸æ¸²æŸ“

                const card = document.createElement('div');
                card.className = 'word-card';
                if (word.isFlipped) card.classList.add('flipped');

                if (!word.isFlipped) {
                    card.textContent = word.text;
                }

                card.dataset.index = index;
                card.addEventListener('click', handleCardClick);

                elements.wordPanel.appendChild(card);
            });
        }

        // å¤„ç†å¡ç‰‡ç‚¹å‡»äº‹ä»¶
        function handleCardClick(event) {
            if (!gameState.isGameStarted || !gameState.isGameReady) return;

            const index = parseInt(event.currentTarget.dataset.index);
            const card = gameState.displayedWords[index];

            // å¦‚æœå¡ç‰‡å·²ç»åŒ¹é…æˆ–å·²ç»ç¿»å¼€ï¼Œåˆ™å¿½ç•¥ç‚¹å‡»
            if (card.isMatched || card.isFlipped || gameState.flippedCards.length >= 2) {
                return;
            }

            // æ’­æ”¾ç¿»ç‰ŒéŸ³æ•ˆ
            if (gameState.soundEnabled) {
                sounds.flip.play();
            }

            // ç¿»å¼€å¡ç‰‡
            card.isFlipped = true;
            gameState.flippedCards.push(index);

            // é‡æ–°æ¸²æŸ“é¢æ¿
            renderWordPanel();

            // æ£€æŸ¥æ˜¯å¦åŒ¹é…
            if (gameState.flippedCards.length === 2) {
                checkForMatch();
            }
        }

        // æ£€æŸ¥ç¿»å¼€çš„å¡ç‰‡æ˜¯å¦åŒ¹é…
        function checkForMatch() {
            const [index1, index2] = gameState.flippedCards;
            const card1 = gameState.displayedWords[index1];
            const card2 = gameState.displayedWords[index2];

            if (card1.pairId === card2.pairId) {
                // åŒ¹é…æˆåŠŸ
                if (gameState.soundEnabled) {
                    sounds.match.play();
                }

                card1.isMatched = true;
                card2.isMatched = true;
                gameState.matchedPairs++;

                // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
                if (gameState.matchedPairs === gameState.totalPairs) {
                    endGame();
                }

                gameState.flippedCards = [];
                // é‡æ–°æ¸²æŸ“é¢æ¿ï¼ŒåŒ¹é…çš„å¡ç‰‡ä¼šæ¶ˆå¤±
                setTimeout(() => {
                    renderWordPanel();
                }, 300);
            } else {
                // åŒ¹é…å¤±è´¥
                if (gameState.soundEnabled) {
                    sounds.mismatch.play();
                }

                // åŒ¹é…å¤±è´¥ï¼Œç¿»å›å»
                setTimeout(() => {
                    card1.isFlipped = false;
                    card2.isFlipped = false;
                    gameState.flippedCards = [];
                    renderWordPanel();
                }, 1000);
            }
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            if (!gameState.isGameReady) {
                alert('è¯·å…ˆé€‰æ‹©å•è¯åº“æˆ–å¯¼å…¥è¯è¡¨ï¼');
                return;
            }

            if (gameState.isGameStarted) {
                // é‡æ–°å¼€å§‹æ¸¸æˆ
                prepareGame();
                return;
            }

            // æ’­æ”¾æ¸¸æˆå¼€å§‹éŸ³æ•ˆ
            if (gameState.soundEnabled) {
                sounds.gameStart.play();
            }

            gameState.isGameStarted = true;
            gameState.startTime = new Date();
            elements.startBtn.innerHTML = '<i class="fas fa-redo"></i> é‡æ–°å¼€å§‹';

            // å¯åŠ¨è®¡æ—¶å™¨
            gameState.timerInterval = setInterval(updateTimer, 1000);

            // å°†æ‰€æœ‰å¡ç‰‡ç¿»é¢
            gameState.displayedWords.forEach(card => {
                card.isFlipped = true;
            });
            renderWordPanel();

            // 3ç§’åç¿»å›å»
            setTimeout(() => {
                gameState.displayedWords.forEach(card => {
                    card.isFlipped = false;
                });
                renderWordPanel();
            }, 3000);
        }

        // æ›´æ–°è®¡æ—¶å™¨
        function updateTimer() {
            const now = new Date();
            const elapsed = Math.floor((now - gameState.startTime) / 1000);
            elements.timer.textContent = `è€—æ—¶: ${elapsed}ç§’`;
        }

        // ç»“æŸæ¸¸æˆ
        function endGame() {
            clearInterval(gameState.timerInterval);

            const now = new Date();
            const elapsed = Math.floor((now - gameState.startTime) / 1000);

            // æ’­æ”¾èƒœåˆ©éŸ³æ•ˆ
            if (gameState.soundEnabled) {
                sounds.gameWin.play();
            }

            // åº†ç¥æ•ˆæœ
            confetti({
                particleCount: 200,
                spread: 90,
                origin: { y: 0.6 },
                colors: ['#D8B4A0', '#DDBEA9', '#A5A58D', '#B7B7A4', '#6B705C', '#FFE8D6']
            });

            setTimeout(() => {
                alert(`ğŸ‰ æ­å–œä½ å®Œæˆäº†æ¸¸æˆï¼\nç”¨æ—¶: ${elapsed}ç§’`);
            }, 800);
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        init();
    </script>
</body>

</html>
